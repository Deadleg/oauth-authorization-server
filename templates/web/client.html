
<!doctype html>
<html>
    <head>
        <title>Client</title>
        {{ template "header" }}
        <script src="https://cdn.jsdelivr.net/sockjs/1/sockjs.min.js"></script>
        <script src="https://d3js.org/d3.v4.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment.min.js"></script>
        <style>
            .chart rect {
                fill: rgb(33,150,243);
            }

            .chart .axis .label {
                fill: black;
                font-size: large;
            }
        </style>
    </head>
    <body>
        <div class="mdl-layout mdl-js-layout mdl-layout--fixed-header">
            {{ template "navbar" .page }}
            <main class="mdl-layout__content">
                <div class="page-content">
                    <div class="mdl-grid">
                        <div class="mdl-layout-spacer"></div>
                        <div class="mdl-cell mdl-cell-8--col">
                            <table class="mdl-data-table mdl-js-data-table full-width">
                                <thead>
                                    <th class="mdl-data-table__cell--non-numeric">ID</th>
                                    <th class="mdl-data-table__cell--non-numeric">Secret</th>
                                    <th class="mdl-data-table__cell--non-numeric">Owner</th>
                                    <th class="mdl-data-table__cell--non-numeric">Rate limit/s</th>
                                    <th class="mdl-data-table__cell--non-numeric">Actions </th>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td class="mdl-data-table__cell--non-numeric">{{ .page.Client.Client.ID }}</a></td>
                                        <td class="mdl-data-table__cell--non-numeric">{{ .page.Client.Client.Secret }}</td>
                                        <td class="mdl-data-table__cell--non-numeric">{{ .page.Client.User.Username }}</td>
                                        <td class="mdl-data-table__cell--non-numeric">{{ .page.Client.Client.RateLimitPerSecond }}</td>
                                        <td class="mdl-data-table__cell--non-numeric">
                                            <button id="show-delete-dialog-{{ .page.Client.Client.ID }}" type="button" class="mdl-button mdl-js-button mdl-button--raised mdl-button--accent">Delete</button>
                                            <dialog id="delete-dialog-{{ .page.Client.Client.ID }}" class="mdl-dialog">
                                                <div class="mdl-dialog__content">
                                                    <p>Are you sure you want to delete {{ .page.Client.Client.ID }}</p>
                                                    <p id="reload-message-{{ .page.Client.Client.ID }}" style="display: none;">Refreshing clients...</p>
                                                    <div id="loading-spinner-{{ .page.Client.Client.ID }}" class="mdl-spinner mdl-spinner--single-color mdl-js-spinner is-active" style="display: none;"></div>
                                                </div>
                                                <div class="mdl-dialog__actions">
                                                    <button id="confirm-delete-{{ .page.Client.Client.ID }}" type="button" class="mdl-button close">Delete</button>
                                                    <button id="close-delete-{{ .page.Client.Client.ID }}" type="button" class="mdl-button close">Cancel</button>
                                                </div>
                                            </dialog>
                                            <script>
                                                $(function() {
                                                    var dialog = document.getElementById('delete-dialog-{{ .page.Client.Client.ID }}');
                                                    var showDialogButton = document.getElementById('show-delete-dialog-{{ .page.Client.Client.ID }}');
                                                    if (!dialog.showModal) {
                                                        dialogPolyfill.registerDialog(dialog);
                                                    }

                                                    showDialogButton.addEventListener('click', function() {
                                                        dialog.showModal();
                                                    });

                                                    dialog.querySelector('#confirm-delete-{{ .page.Client.Client.ID }}').addEventListener('click', function() {
                                                        document.getElementById('loading-spinner-{{ .page.Client.Client.ID }}').style.display = 'block';
                                                        document.getElementById("reload-message-{{ .page.Client.Client.ID }}").style.display = 'block';
                                                        $.post("/account/clients/delete/{{ .page.Client.Client.ID }}", {"gorilla.csrf.Token": "{{ $.csrfField }}"}, function(data) {
                                                            location.reload();
                                                        });
                                                    });

                                                    dialog.querySelector('#close-delete-{{ .page.Client.Client.ID }}').addEventListener('click', function() {
                                                        dialog.close();
                                                    });
                                                });
                                            </script>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="mdl-layout-spacer"></div>
                    </div>
                    <div class="mdl-grid">
                        <div class="mdl-layout-spacer"></div>
                        <div class="mdl-cell mdl-cell-8--col">
                            <svg class="chart"></svg>
                        </div>
                        <div class="mdl-layout-spacer"></div>
                    </div>
                </div>
            </main>
        </div>
        <script>
            var sock = new SockJS('/ws/account/clients/');
            sock.onopen = function() {
                sock.send('["{{ .page.Client.Client.ID }}"]')
                console.log('open');
            };

            sock.onmessage = function(e) {
                console.log('message', e.data);
            };

            sock.onclose = function() {
                console.log('close');
            };

            var margin = {top: 20, bottom: 50, left: 60, right: 20};
            var barWidth = 30;
            var graphWidth = barWidth * 20;
            var chartWidth = graphWidth + margin.left + margin.right;
            var xLabelHeight = 40;
            var maxBarHeight = 500;
            var barTopText = 20;
            var chartHeight = maxBarHeight + xLabelHeight + barTopText + margin.top + margin.bottom;

            var y = d3.scaleLinear()
                    .range([maxBarHeight, 0]);

            var x = d3.scaleBand()
                .range([0, graphWidth])
                .round(true)
                .padding(0.1);

            var chart = d3.select(".chart")
                    .attr('width', chartWidth)
                    .attr('height', chartHeight)
                    .append('g')
                    .attr('transform', 'translate(' + margin.left + ', ' + margin.top + ')');

            var yAxis = d3.axisLeft(y);

            var xAxis = d3.axisBottom(x);
            xAxis.tickFormat(d => { 
                return moment.unix(d).format('MM-DD H:mm'); 
            })

            chart.append("g")
                    .attr("class", "y axis")
                    .call(yAxis)
                    .append("text")
                    .attr("transform", "rotate(-90) translate(-" + maxBarHeight/2 + ", -40)")
                    .style("text-anchor", "middle")
                    .attr("class", "label")
                    .text("Number of requests");

            chart.append("g")
                    .attr("class", "x axis")
                    .attr("transform", "translate(0," +  (maxBarHeight) + ")")
                    .call(xAxis)
                    .append("text")
                    .attr("transform", "translate(" + graphWidth/2 + ", 40)")
                    .style("text-anchor", "middle")
                    .attr("class", "label")
                    .text("Date");

            function updateGraph(data) {
                data.sort(function(a,b) {
                    return a.timestamp - b.timestamp
                })

                x.domain(data.map(d => { return d.timestamp }));
                y.domain([0, d3.max(data, function(d) { 
                        return d.value;
                })])
                chart.selectAll(".y.axis")
                    .call(yAxis);
                chart.selectAll(".x.axis")
                    .call(xAxis);

                var color;
                var bar = chart.selectAll('rect')
                        .remove()
                        .exit()
                        .data(data);
                bar.enter().append('rect')
                        .attr('y', function(d) { 
                            return y(d.value); 
                        })
                        .attr('x', function(d, i) { 
                            return x(d.timestamp) - 1; 
                        })
                        .attr('width', x.bandwidth())
                        .attr('height', function(d) {
                            return maxBarHeight - y(d.value); 
                        })
                        .on('mouseover', function(data) {
                            color = this.style.fill;
                            d3.select(this)
                                .style('fill', '#f37e21')
                        })
                        .on('mouseout', function(data) {
                            d3.select(this)
                                .style('fill', color)
                        })
                        .merge(bar);

                    bar.exit().remove();
            }

            function updateEventCounts() {
                $.getJSON("/account/clients/{{ .page.Client.Client.ID }}/eventCounts")
                .done(function(d) {
                    console.log(d);
                    updateGraph(d)
                })
                .always(function() {
                    setTimeout(updateEventCounts, 5000);
                });
            };

            function updateEvents() {
                $.getJSON("/account/clients/{{ .page.Client.Client.ID }}/events")
                .done(function(d) {
                    console.log(d);
                });
            }

            updateEventCounts();
            updateEvents();
        </script>
    </body>
</html>